<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Animation Creator</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { background:#f0f2f5; margin:0; font-family:Segoe UI, sans-serif; display:flex; flex-direction:column; align-items:center; padding:10px }
    #toolbar { background:#fff; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding:10px; margin-bottom:10px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; width:100%; max-width:800px }
    .tool-group { display:flex; align-items:center; gap:5px; flex-wrap:wrap }
    button { background:#007bff; color:#fff; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; transition:background .2s; white-space:nowrap }
    button:hover { background:#0056b3 }
    button.active { background:#0056b3 }
    input[type=color],input[type=number] { padding:5px; border-radius:4px; border:1px solid #ccc }
    label { font-size:14px; color:#333 }
    #main { width:100%; max-width:800px; display:flex; flex-direction:column; align-items:center }
    #canvas { border:2px solid #ccc; border-radius:8px; background:#fff; touch-action:none; width:100%; max-width:800px }
    #framesPanel { margin-top:10px; display:flex; gap:5px; overflow-x:auto; padding-bottom:5px }
    #framesPanel img { width:80px; height:auto; border:2px solid transparent; cursor:grab; border-radius:4px }
    #framesPanel img.active-frame { border-color:#007bff }
    /* Selection resize handles */
    .handle { position:absolute; width:10px; height:10px; background:#007bff; border:1px solid #fff; border-radius:2px; cursor:se-resize; }
    @media(max-width:480px){
      #toolbar { flex-direction:column; align-items:stretch; gap:5px }
      .tool-group { justify-content:space-around }
      button { flex:1 1 auto; font-size:12px; padding:6px 8px }
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <div class="tool-group">
      <button id="penTool" class="active">Pen</button>
      <button id="eraserTool">Eraser</button>
      <button id="bucketTool">Bucket</button>
      <button id="selectTool">Select</button>
      <button id="copySelection">Copy</button>
      <button id="pasteTool">Paste</button>
      <button id="undoBtn">Undo</button>
    </div>
    <div class="tool-group">
      <input type="color" id="colorPicker" value="#000000">
      <button id="importImageBtn">Import Image</button>
      <input type="file" id="importImage" accept="image/*" style="display:none">
    </div>
    <div class="tool-group">
      <button id="addFrame">Add Frame</button>
      <button id="deleteFrame">Delete Frame</button>
      <label>FPS:</label><input type="number" id="frameRateInput" min="1" max="60" value="30">
      <button id="previewAnim">Preview</button>
      <button id="downloadMP4">Download MP4</button>
    </div>
    <div class="tool-group">
      <label>Bg Color:</label><input type="color" id="bgColorPicker" value="#ffffff">
      <button id="uploadBgBtn">Upload BG</button>
      <input type="file" id="uploadBg" accept="image/*" style="display:none">
    </div>
    <div class="tool-group">
      <button id="saveProject">Save</button>
      <button id="loadProject">Load</button>
      <input type="file" id="loadProjectInput" accept=".json" style="display:none">
    </div>
  </div>
  <div id="main">
    <canvas id="canvas" width="800" height="500"></canvas>
    <div id="framesPanel"></div>
  </div>

  <script>
  // === References & State ===
  const canvas=document.getElementById('canvas'),
        ctx=canvas.getContext('2d'),
        framesPanel=document.getElementById('framesPanel'),
        penTool=document.getElementById('penTool'),
        eraserTool=document.getElementById('eraserTool'),
        bucketTool=document.getElementById('bucketTool'),
        selectTool=document.getElementById('selectTool'),
        copyBtn=document.getElementById('copySelection'),
        pasteTool=document.getElementById('pasteTool'),
        undoBtn=document.getElementById('undoBtn'),
        colorPicker=document.getElementById('colorPicker'),
        importBtn=document.getElementById('importImageBtn'),
        importInput=document.getElementById('importImage'),
        addFrameBtn=document.getElementById('addFrame'),
        deleteFrameBtn=document.getElementById('deleteFrame'),
        frameRateInput=document.getElementById('frameRateInput'),
        previewBtn=document.getElementById('previewAnim'),
        downloadBtn=document.getElementById('downloadMP4'),
        bgColorPicker=document.getElementById('bgColorPicker'),
        uploadBgBtn=document.getElementById('uploadBgBtn'),
        uploadBgInput=document.getElementById('uploadBg'),
        saveBtn=document.getElementById('saveProject'),
        loadBtn=document.getElementById('loadProject'),
        loadInput=document.getElementById('loadProjectInput');

  let currentTool='pen',drawing=false,lastX=0,lastY=0,
      frames=[],currentFrameIndex=-1,previewInterval=null,
      lastFrameData=null,
      isSelecting=false,isSelectionActive=false,selectionStart=null,
      selectionRect=null,savedSelectionImage=null,
      isMoving=false,moveOffset={},movePos=null,
      background={color:'#ffffff',image:null},
      undoStack=[],clipboard=null;

  const offscreen=document.createElement('canvas');
  offscreen.width=canvas.width;offscreen.height=canvas.height;
  const offctx=offscreen.getContext('2d');

  // === Helpers ===
  function getPos(e){
    const r=canvas.getBoundingClientRect();
    let cx,cy;
    if(e.touches&&e.touches[0]){cx=e.touches[0].clientX;cy=e.touches[0].clientY;}
    else{cx=e.clientX;cy=e.clientY;}
    const sx=canvas.width/r.width,sy=canvas.height/r.height;
    return {x:(cx-r.left)*sx,y:(cy-r.top)*sy};
  }
  function pushUndo(){undoStack.push(offctx.getImageData(0,0,canvas.width,canvas.height));}
  function undo(){if(undoStack.length){offctx.putImageData(undoStack.pop(),0,0);redraw();}}
  function redraw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(background.image){
      const img=new Image();img.onload=()=>{ctx.drawImage(img,0,0,canvas.width,canvas.height);drawOverlay();};
      img.src=background.image;
    } else {ctx.fillStyle=background.color;ctx.fillRect(0,0,canvas.width,canvas.height);drawOverlay();}
    function drawOverlay(){
      if(lastFrameData){
        ctx.globalAlpha=0.3;
        const s=new Image();s.onload=()=>{ctx.drawImage(s,0,0,canvas.width,canvas.height);ctx.globalAlpha=1;ctx.drawImage(offscreen,0,0);};
        s.src=lastFrameData;
      } else ctx.drawImage(offscreen,0,0);
    }
  }
  function updateTools(){
    [penTool,eraserTool,bucketTool,selectTool,pasteTool].forEach(b=>b.classList.remove('active'));
    if(currentTool==='pen')penTool.classList.add('active');
    if(currentTool==='eraser')eraserTool.classList.add('active');
    if(currentTool==='bucket')bucketTool.classList.add('active');
    if(currentTool==='select')selectTool.classList.add('active');
    if(currentTool==='paste')pasteTool.classList.add('active');
  }

  // === Drawing ===
  function startDraw(e){
    if(!['pen','eraser'].includes(currentTool))return;
    drawing=true;const p=getPos(e);lastX=p.x;lastY=p.y;
    if(currentTool==='eraser'){offctx.save();offctx.globalCompositeOperation='destination-out';offctx.lineWidth=10;}
    else{offctx.globalCompositeOperation='source-over';offctx.lineWidth=3;offctx.strokeStyle=colorPicker.value;}
  }
  function draw(e){if(!drawing)return;const p=getPos(e);offctx.beginPath();offctx.moveTo(lastX,lastY);offctx.lineTo(p.x,p.y);offctx.stroke();lastX=p.x;lastY=p.y;redraw();}
  function stopDraw(){if(currentTool==='eraser')offctx.restore();drawing=false;}

  // === Bucket ===
  function bucket(x,y,color){
    let img=offctx.getImageData(0,0,canvas.width,canvas.height),d=img.data,w=canvas.width,h=canvas.height,
        hex=color.replace('#',''),rF=parseInt(hex.slice(0,2),16),gF=parseInt(hex.slice(2,4),16),
        bF=parseInt(hex.slice(4,6),16),aF=255,stack=[[x,y]],o=(y*w+x)*4,
        rT=d[o],gT=d[o+1],bT=d[o+2],aT=d[o+3];
    if(rT===rF&&gT===gF&&bT===bF&&aT===aF)return;
    function match(i){return d[i]===rT&&d[i+1]===gT&&d[i+2]===bT&&d[i+3]===aT;}
    while(stack.length){
      let [cx,cy]=stack.pop(),pos=(cy*w+cx)*4;
      while(cy>=0&&match(pos)){cy--;pos-=w*4;}
      cy++;pos+=w*4;let l=false,r=false;
      while(cy<h&&match(pos)){
        d[pos]=rF;d[pos+1]=gF;d[pos+2]=bF;d[pos+3]=aF;
        if(cx>0){if(match(pos-4)){if(!l){stack.push([cx-1,cy]);l=true;}}else l=false;}
        if(cx<w-1){if(match(pos+4)){if(!r){stack.push([cx+1,cy]);r=true;}}else r=false;}
        cy++;pos+=w*4;
      }
    }
    offctx.putImageData(img,0,0);
  }

  // === Selection & Resize ===
  function selStart(p){
    if(isSelectionActive&&p.x>=selectionRect.x&&p.x<=selectionRect.x+selectionRect.width
       &&p.y>=selectionRect.y&&p.y<=selectionRect.y+selectionRect.height){
      isMoving=true;moveOffset={x:p.x-selectionRect.x,y:p.y-selectionRect.y};movePos={x:selectionRect.x,y:selectionRect.y};
    } else {
      isSelecting=true;selectionStart=p;
      selectionRect={x:p.x,y:p.y,width:0,height:0};
      savedSelectionImage=offctx.getImageData(0,0,canvas.width,canvas.height);
      isSelectionActive=false;
    }
  }
  function selMove(p){
    if(isSelecting){
      selectionRect.x=Math.min(selectionStart.x,p.x);
      selectionRect.y=Math.min(selectionStart.y,p.y);
      selectionRect.width=Math.abs(p.x-selectionStart.x);
      selectionRect.height=Math.abs(p.y-selectionStart.y);
      redraw();ctx.save();ctx.setLineDash([5,3]);ctx.strokeStyle='red';
      ctx.strokeRect(selectionRect.x,selectionRect.y,selectionRect.width,selectionRect.height);ctx.restore();
    } else if(isMoving){
      movePos={x:p.x-moveOffset.x,y:p.y-moveOffset.y};
      redraw();ctx.putImageData(savedSelectionImage,movePos.x,movePos.y);
      ctx.save();ctx.setLineDash([5,3]);ctx.strokeStyle='red';
      ctx.strokeRect(movePos.x,movePos.y,selectionRect.width,selectionRect.height);ctx.restore();
    }
  }
  function selEnd(){
    if(isSelecting){
      isSelecting=false;
      if(selectionRect.width&&selectionRect.height){
        savedSelectionImage=offctx.getImageData(selectionRect.x,selectionRect.y,selectionRect.width,selectionRect.height);
        isSelectionActive=true;
      }
      redraw();if(selectionRect){ctx.save();ctx.setLineDash([5,3]);ctx.strokeStyle='red';
        ctx.strokeRect(selectionRect.x,selectionRect.y,selectionRect.width,selectionRect.height);ctx.restore();}
    } else if(isMoving){
      pushUndo();
      offctx.clearRect(selectionRect.x,selectionRect.y,selectionRect.width,selectionRect.height);
      offctx.putImageData(savedSelectionImage,movePos.x,movePos.y);
      selectionRect.x=movePos.x;selectionRect.y=movePos.y;
      isMoving=false;isSelectionActive=false;redraw();
    }
  }

  // === Copy & Paste ===
  copyBtn.onclick=()=>{
    if(isSelectionActive){clipboard=savedSelectionImage;alert('Copied!');}
    else alert('No selection');
  };
  function pasteAt(e){
    if(!clipboard){alert('No clipboard');return;}
    pushUndo();const p=getPos(e);
    offctx.putImageData(clipboard,p.x,p.y);redraw();currentTool='pen';updateTools();
  }

  // === Canvas Events ===
  function cStart(e){e.preventDefault();const p=getPos(e);
    if(currentTool==='select')selStart(p);
    else if(['pen','eraser'].includes(currentTool)){pushUndo();startDraw(e);}
    else if(currentTool==='bucket'){pushUndo();bucket(Math.floor(p.x),Math.floor(p.y),colorPicker.value);redraw();}
    else if(currentTool==='paste')pasteAt(e);
  }
  function cMove(e){e.preventDefault();
    if((currentTool==='pen'||currentTool==='eraser')&&drawing)draw(e);
    else if(currentTool==='select')selMove(getPos(e));
  }
  function cEnd(e){e.preventDefault();
    if(['pen','eraser'].includes(currentTool))stopDraw();
    else if(currentTool==='select')selEnd();
  }
  canvas.addEventListener('mousedown',cStart);
  canvas.addEventListener('mousemove',cMove);
  canvas.addEventListener('mouseup',cEnd);
  canvas.addEventListener('mouseout',cEnd);
  canvas.addEventListener('touchstart',cStart);
  canvas.addEventListener('touchmove',cMove);
  canvas.addEventListener('touchend',cEnd);

  // === Import Image Proportional ===
  importBtn.onclick=()=>importInput.click();
  importInput.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=ev=>{
      const img=new Image();img.onload=()=>{
        pushUndo();
        const scale=Math.min(canvas.width/img.width,canvas.height/img.height,1),
              w=img.width*scale,h=img.height*scale;
        offctx.drawImage(img,0,0,w,h);redraw();
      };
      img.src=ev.target.result;
    };
    r.readAsDataURL(f);
  };

  // === Frame Management with Drag & Drop ===
  addFrameBtn.onclick=()=>{
    const tmp=document.createElement('canvas');
    tmp.width=canvas.width;tmp.height=canvas.height;
    const tctx=tmp.getContext('2d');
    if(background.image){
      const bgi=new Image();
      bgi.onload=()=>{
        tctx.drawImage(bgi,0,0,canvas.width,canvas.height);
        tctx.drawImage(offscreen,0,0);
        pushFrame(tmp.toDataURL());
      };
      bgi.src=background.image;
    } else {
      tctx.fillStyle=background.color; tctx.fillRect(0,0,canvas.width,canvas.height);
      tctx.drawImage(offscreen,0,0);
      pushFrame(tmp.toDataURL());
    }
  };
  function pushFrame(dataURL){
    frames.push(dataURL);
    currentFrameIndex=frames.length-1;
    lastFrameData=dataURL;
    offctx.clearRect(0,0,canvas.width,canvas.height);
    undoStack.length=0; updateFrames(); redraw();
  }
  deleteFrameBtn.onclick=()=>{
    if(currentFrameIndex<0)return alert('No frame');
    frames.splice(currentFrameIndex,1);
    if(!frames.length){currentFrameIndex=-1;lastFrameData=null;offctx.clearRect(0,0,canvas.width,canvas.height);redraw();}
    else{currentFrameIndex=Math.max(0,currentFrameIndex-1);loadFrame(currentFrameIndex);}
    updateFrames();
  };
  function updateFrames(){
    framesPanel.innerHTML='';
    frames.forEach((f,i)=>{
      const img=document.createElement('img');
      img.src=f; img.draggable=true;
      if(i===currentFrameIndex)img.classList.add('active-frame');
      img.addEventListener('click',()=>{loadFrame(i);updateFrames();});
      img.addEventListener('dragstart',e=>{
        e.dataTransfer.setData('text/plain',i);
      });
      img.addEventListener('dragover',e=>{e.preventDefault();});
      img.addEventListener('drop',e=>{
        e.preventDefault();
        const src=+e.dataTransfer.getData('text/plain'),dst=i;
        const [moved]=frames.splice(src,1);
        frames.splice(dst,0,moved);
        currentFrameIndex=dst;
        updateFrames();
      });
      framesPanel.appendChild(img);
    });
  }
  function loadFrame(i){
    currentFrameIndex=i;
    const img=new Image();
    img.onload=()=>{
      offctx.clearRect(0,0,canvas.width,canvas.height);
      offctx.drawImage(img,0,0,canvas.width,canvas.height);
      lastFrameData=frames[i]; undoStack.length=0; redraw();
    };
    img.src=frames[i];
  }

  // === Preview & Download (unchanged) ===
  previewBtn.onclick=()=>{
    if(!frames.length)return alert('No frames');
    let i=0;clearInterval(previewInterval);
    previewInterval=setInterval(()=>{
      const img=new Image();
      img.onload=()=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(background.image){
          const bg=new Image();
          bg.onload=()=>{ctx.drawImage(bg,0,0,canvas.width,canvas.height);ctx.drawImage(img,0,0,canvas.width,canvas.height);};
          bg.src=background.image;
        } else {
          ctx.fillStyle=background.color;ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
        }
      };
      img.src=frames[i];
      i=(i+1)%frames.length;
    },1000/parseInt(frameRateInput.value));
    setTimeout(()=>{clearInterval(previewInterval);if(currentFrameIndex>=0)loadFrame(currentFrameIndex);},5000);
  };
  downloadBtn.onclick=()=>{
    if(!frames.length)return alert('No frames');
    const fps=parseInt(frameRateInput.value)||30;
    const stream=canvas.captureStream(fps);
    let opts={mimeType:'video/mp4'};
    if(!MediaRecorder.isTypeSupported(opts.mimeType)){
      if(MediaRecorder.isTypeSupported('video/webm;codecs=vp9'))opts.mimeType='video/webm;codecs=vp9';
      else if(MediaRecorder.isTypeSupported('video/webm;codecs=vp8'))opts.mimeType='video/webm;codecs=vp8';
      else return alert('No format');
    }
    let recChunks=[];
    const rec=new MediaRecorder(stream,opts);
    rec.ondataavailable=e=>{if(e.data.size)recChunks.push(e.data)};
    rec.onstop=()=>{
      const blob=new Blob(recChunks,{type:opts.mimeType}),url=URL.createObjectURL(blob),
            a=document.createElement('a');
      a.href=url;a.download='animation.mp4';document.body.appendChild(a);a.click();
      document.body.removeChild(a);URL.revokeObjectURL(url);
    };
    rec.start();
    let i=0,delay=1000/fps;
    (function play(){
      if(i>=frames.length){rec.stop();if(currentFrameIndex>=0)loadFrame(currentFrameIndex);return;}
      const img=new Image();
      img.onload=()=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(background.image){
          const bg=new Image();
          bg.onload=()=>{ctx.drawImage(bg,0,0,canvas.width,canvas.height);ctx.drawImage(img,0,0,canvas.width,canvas.height);};
          bg.src=background.image;
        } else {
          ctx.fillStyle=background.color;ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
        }
        setTimeout(()=>{i++;play()},delay);
      };
      img.src=frames[i];
    })();
  };

  // === Background ===
  bgColorPicker.onchange=e=>{background.color=e.target.value;redraw()};
  uploadBgBtn.onclick=()=>uploadBgInput.click();
  uploadBgInput.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=ev=>{background.image=ev.target.result;redraw()};
    r.readAsDataURL(f);
  };

  // === Save/Load ===
  saveBtn.onclick=()=>{
    const proj={frames, currentFrameIndex, background},
          data='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(proj)),
          a=document.createElement('a');
    a.href=data;a.download='anim_project.json';document.body.appendChild(a);a.click();document.body.removeChild(a);
  };
  loadBtn.onclick=()=>loadInput.click();
  loadInput.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=ev=>{
      const p=JSON.parse(ev.target.result);
      frames=p.frames||[];currentFrameIndex=p.currentFrameIndex||-1;
      background=p.background||{color:'#ffffff',image:null};
      bgColorPicker.value=background.color;
      updateFrames();
      if(currentFrameIndex>=0)loadFrame(currentFrameIndex);
      else{offctx.clearRect(0,0,canvas.width,canvas.height);redraw();}
    };
    r.readAsText(f);
  };

  // === Service Worker ===
  if('serviceWorker'in navigator){
    window.addEventListener('load',()=>{
      navigator.serviceWorker.register('service-worker.js').catch(console.error);
    });
  }

  // === Init ===
  offctx.clearRect(0,0,canvas.width,canvas.height);
  redraw();
  </script>
</body>
</html>












